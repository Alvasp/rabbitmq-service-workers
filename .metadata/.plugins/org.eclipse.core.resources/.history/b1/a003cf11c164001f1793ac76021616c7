package com.poc.reactive.demo.controller;

import java.util.UUID;

import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RestController;

import com.poc.reactive.demo.dto.AddJobRequest;
import com.poc.reactive.demo.messaging.HandleImageRequestMessage;
import com.poc.reactive.demo.messaging.Resolution;

@RestController
public class ImageJobController {

	@Autowired
	RabbitTemplate template;

	@PostMapping(value = "/add-job")
	public void addJob(@RequestBody AddJobRequest request) {

		HandleImageRequestMessage message = new HandleImageRequestMessage(request.filename(),
				new Resolution(request.resolution().width(), request.resolution().height()));

		String correlation = UUID.randomUUID().toString();

		template.convertAndSend("image-processing-exchange", request.type().getDescription(), message,
				messagePostProcessor -> {
					messagePostProcessor.getMessageProperties().setReplyTo("image-processing-queue-tasks-response");
					messagePostProcessor.getMessageProperties().setCorrelationId(correlation);
					return messagePostProcessor;
				});

	}

}
